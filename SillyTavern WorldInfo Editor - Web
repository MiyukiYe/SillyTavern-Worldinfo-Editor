<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SillyTavern ä¸–ç•Œä¹¦ Web ç¼–è¾‘å™¨</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <style>
        /* è‡ªå®šä¹‰æ»šåŠ¨æ¡ï¼Œä¿æŒä¼˜é›… */
        ::-webkit-scrollbar { width: 6px; height: 6px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background-color: #cbd5e1; border-radius: 3px; }
        ::-webkit-scrollbar-thumb:hover { background-color: #94a3b8; }
        /* éšè—é»˜è®¤çš„æ–‡ä»¶ä¸Šä¼ æŒ‰é’®æ ·å¼ */
        input[type="file"] { display: none; }
    </style>
</head>
<body class="bg-slate-50 text-slate-800 font-sans h-screen overflow-hidden">

<div id="app" class="h-full flex flex-col">
    <header class="bg-white border-b border-blue-100 shadow-sm px-4 py-3 flex justify-between items-center z-10 shrink-0">
        <div class="flex items-center gap-2">
            <span class="text-xl font-bold text-blue-500">ğŸ“–</span>
            <h1 class="text-lg font-bold text-slate-700 hidden sm:block">SillyTavern ä¸–ç•Œä¹¦ç¼–è¾‘å™¨</h1>
            <h1 class="text-lg font-bold text-slate-700 sm:hidden">ST ç¼–è¾‘å™¨</h1>
        </div>
        <div class="flex gap-2 text-sm">
            <label class="bg-blue-50 text-blue-600 px-4 py-2 rounded-lg cursor-pointer hover:bg-blue-100 font-medium transition flex items-center gap-1">
                <span>ğŸ“‚ æ‰“å¼€</span>
                <input type="file" accept=".json" @change="importFile">
            </label>
            <button @click="exportFile" class="bg-blue-500 text-white px-4 py-2 rounded-lg hover:bg-blue-600 font-medium transition shadow-sm shadow-blue-200">
                ğŸ’¾ å¯¼å‡ºä¿å­˜
            </button>
        </div>
    </header>

    <div class="flex-1 flex overflow-hidden relative">
        
        <aside :class="['w-full md:w-80 bg-white border-r border-slate-200 flex flex-col shrink-0 transition-all duration-300', currentEntryId ? 'hidden md:flex' : 'flex']">
            <div class="p-3 border-b border-slate-100 flex gap-2 bg-slate-50/50">
                <input type="text" v-model="searchQuery" placeholder="ğŸ” æœç´¢æ¡ç›®..." 
                       class="flex-1 px-3 py-2 bg-white border border-slate-200 rounded-md focus:outline-none focus:border-blue-400 focus:ring-1 focus:ring-blue-400 text-sm transition">
                <button @click="addEntry" class="bg-blue-500 text-white px-3 py-2 rounded-md hover:bg-blue-600 transition" title="æ–°å¢æ¡ç›®">â•</button>
            </div>
            
            <div class="flex-1 overflow-y-auto p-2 space-y-1">
                <div v-if="Object.keys(filteredEntries).length === 0" class="text-center text-slate-400 py-10 text-sm">
                    æš‚æ— æ¡ç›®æˆ–æœç´¢æ— ç»“æœ
                </div>
                <div v-for="(entry, key) in filteredEntries" :key="key" 
                     @click="selectEntry(key)"
                     :class="['px-3 py-3 rounded-lg cursor-pointer transition text-sm flex justify-between items-center group', 
                              currentEntryId === key ? 'bg-blue-500 text-white shadow-md shadow-blue-200/50' : 'hover:bg-blue-50 text-slate-700']">
                    <div class="truncate pr-2 font-medium">
                        {{ entry.comment || (entry.key && entry.key.length ? entry.key.join(', ') : 'æœªå‘½åæ¡ç›® ' + key) }}
                    </div>
                </div>
            </div>
        </aside>

        <main :class="['flex-1 bg-slate-50 flex flex-col overflow-hidden', !currentEntryId ? 'hidden md:flex' : 'flex']">
            
            <div v-if="currentEntryId && worldInfoData[currentEntryId]" class="flex-1 overflow-y-auto p-4 md:p-6 lg:p-8">
                <button @click="currentEntryId = null" class="md:hidden mb-4 text-blue-500 flex items-center gap-1 bg-white px-3 py-1.5 rounded-md shadow-sm border border-slate-200">
                    <span>â—€ è¿”å›åˆ—è¡¨</span>
                </button>

                <div class="max-w-4xl mx-auto space-y-6">
                    <div class="bg-white p-5 rounded-xl border border-slate-200 shadow-sm">
                        <div class="flex justify-between items-center mb-4">
                            <h2 class="text-lg font-bold text-slate-800">åŸºç¡€è®¾å®š</h2>
                            <button @click="deleteEntry(currentEntryId)" class="text-red-500 hover:text-red-600 hover:bg-red-50 px-3 py-1 rounded text-sm transition">
                                âŒ åˆ é™¤æ­¤æ¡ç›®
                            </button>
                        </div>
                        
                        <div class="space-y-4">
                            <div>
                                <label class="block text-sm font-bold text-slate-700 mb-1">æ ‡é¢˜/å¤‡æ³¨ (Comment)</label>
                                <input type="text" v-model="worldInfoData[currentEntryId].comment" class="w-full px-3 py-2 border border-slate-200 rounded-md focus:border-blue-400 focus:ring-1 focus:ring-blue-400 bg-slate-50 focus:bg-white transition text-sm">
                            </div>

                            <div>
                                <label class="block text-sm font-bold text-slate-700 mb-1">è§¦å‘è¯ (Keys) <span class="text-xs font-normal text-slate-400 font-normal ml-1">ä½¿ç”¨é€—å·åˆ†éš”</span></label>
                                <input type="text" v-model="keysString" class="w-full px-3 py-2 border border-slate-200 rounded-md focus:border-blue-400 focus:ring-1 focus:ring-blue-400 bg-slate-50 focus:bg-white transition text-sm">
                            </div>

                            <div>
                                <label class="block text-sm font-bold text-slate-700 mb-1">æ¡ç›®å†…å®¹ (Content)</label>
                                <textarea v-model="worldInfoData[currentEntryId].content" rows="6" class="w-full px-3 py-2 border border-slate-200 rounded-md focus:border-blue-400 focus:ring-1 focus:ring-blue-400 bg-slate-50 focus:bg-white transition text-sm leading-relaxed"></textarea>
                            </div>
                            
                            <div class="flex items-center gap-2 pt-2">
                                <input type="checkbox" v-model="isEntryEnabled" id="enableToggle" class="w-4 h-4 text-blue-500 rounded border-slate-300 focus:ring-blue-400">
                                <label for="enableToggle" class="text-sm font-bold text-slate-700 cursor-pointer">âœ… å¯ç”¨æ­¤æ¡ç›® (Enable)</label>
                            </div>
                        </div>
                    </div>

                    <div class="bg-white p-5 rounded-xl border border-slate-200 shadow-sm">
                        <h2 class="text-lg font-bold text-slate-800 mb-4">æ’å…¥ä¸åŒ¹é…</h2>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div>
                                <label class="block text-sm font-bold text-slate-700 mb-1">æ’åºæƒé‡ (Order)</label>
                                <input type="number" v-model.number="worldInfoData[currentEntryId].order" class="w-full px-3 py-2 border border-slate-200 rounded-md focus:border-blue-400 focus:ring-1 focus:ring-blue-400 bg-slate-50 focus:bg-white text-sm">
                            </div>
                            <div>
                                <label class="block text-sm font-bold text-slate-700 mb-1">æ’å…¥ä½ç½® (Position)</label>
                                <select v-model.number="worldInfoData[currentEntryId].position" class="w-full px-3 py-2 border border-slate-200 rounded-md focus:border-blue-400 focus:ring-1 focus:ring-blue-400 bg-slate-50 focus:bg-white text-sm">
                                    <option value="0">è§’è‰²å®šä¹‰å‰</option>
                                    <option value="1">è§’è‰²å®šä¹‰å</option>
                                    <option value="2">ç¤ºä¾‹æ¶ˆæ¯å‰</option>
                                    <option value="3">ç¤ºä¾‹æ¶ˆæ¯å</option>
                                    <option value="4">ä½œè€…æ³¨é‡Šé¡¶</option>
                                    <option value="5">ä½œè€…æ³¨é‡Šåº•</option>
                                    <option value="6">@ ç‰¹å®šæ·±åº¦</option>
                                    <option value="7">å‡ºå£ (Outlet)</option>
                                </select>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div v-else class="flex-1 flex items-center justify-center text-slate-400 flex-col gap-4">
                <div class="text-6xl opacity-50">ğŸ“–</div>
                <p>è¯·åœ¨å·¦ä¾§é€‰æ‹©ä¸€ä¸ªæ¡ç›®ï¼Œæˆ–ç‚¹å‡»æ–°å¢å¼€å§‹ç¼–è¾‘</p>
                <p class="text-sm">æ‰‹æœºç«¯ä¼šè‡ªåŠ¨ä¸ºæ‚¨åˆ‡æ¢è§†å›¾</p>
            </div>
        </main>
    </div>
</div>

<script>
    const { createApp, ref, computed } = Vue;

    createApp({
        setup() {
            // æ ¸å¿ƒçŠ¶æ€
            const worldInfoData = ref({});
            const currentEntryId = ref(null);
            const searchQuery = ref("");
            const fileName = ref("world info.json");

            // è¯»å–æ–‡ä»¶
            const importFile = (event) => {
                const file = event.target.files[0];
                if (!file) return;
                fileName.value = file.name;

                const reader = new FileReader();
                reader.onload = (e) => {
                    try {
                        const json = JSON.parse(e.target.result);
                        if (json.entries) {
                            worldInfoData.value = json.entries;
                            currentEntryId.value = null; // é‡ç½®é€‰ä¸­çŠ¶æ€
                        } else {
                            alert("è¯»å–å¤±è´¥ï¼šè¿™ä¸æ˜¯ä¸€ä¸ªæœ‰æ•ˆçš„ SillyTavern ä¸–ç•Œä¹¦æ–‡ä»¶ã€‚");
                        }
                    } catch (err) {
                        alert("è§£æ JSON å¤±è´¥ï¼š" + err.message);
                    }
                };
                reader.readAsText(file);
                event.target.value = ''; // æ¸…ç©º input å…è®¸é‡å¤é€‰æ‹©åŒåæ–‡ä»¶
            };

            // å¯¼å‡ºæ–‡ä»¶
            const exportFile = () => {
                if (Object.keys(worldInfoData.value).length === 0) {
                    alert("å½“å‰æ²¡æœ‰å¯å¯¼å‡ºçš„æ•°æ®ï¼");
                    return;
                }
                const saveObj = { entries: worldInfoData.value };
                const jsonStr = JSON.stringify(saveObj, null, 0); // æ— å¤šä½™ç¼©è¿›ä¿æŒç´§å‡‘
                
                const blob = new Blob([jsonStr], { type: "application/json" });
                const url = URL.createObjectURL(blob);
                const a = document.createElement("a");
                a.href = url;
                a.download = fileName.value;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
            };

            // æœç´¢è¿‡æ»¤è®¡ç®—å±æ€§
            const filteredEntries = computed(() => {
                if (!searchQuery.value) return worldInfoData.value;
                const query = searchQuery.value.toLowerCase();
                const result = {};
                for (const [key, entry] of Object.entries(worldInfoData.value)) {
                    const title = (entry.comment || "").toLowerCase();
                    const keysStr = (entry.key ? entry.key.join(', ') : "").toLowerCase();
                    const content = (entry.content || "").toLowerCase();
                    
                    if (title.includes(query) || keysStr.includes(query) || content.includes(query)) {
                        result[key] = entry;
                    }
                }
                return result;
            });

            // é€‰ä¸­æ¡ç›®
            const selectEntry = (id) => {
                currentEntryId.value = id;
            };

            // æ–°å¢æ¡ç›®
            const addEntry = () => {
                const keys = Object.keys(worldInfoData.value).map(Number).filter(k => !isNaN(k));
                const newId = keys.length > 0 ? Math.max(...keys) + 1 : 0;
                
                // é»˜è®¤æ•°æ®ç»“æ„
                worldInfoData.value[newId] = {
                    uid: newId, key: [], keysecondary: [], comment: "æ–°æ¡ç›®", content: "",
                    constant: false, vectorized: false, selective: true, selectiveLogic: 0,
                    addMemo: true, order: 100, position: 0, disable: false, ignoreBudget: false,
                    excludeRecursion: false, preventRecursion: false, delayUntilRecursion: false, recursionLevel: 0,
                    matchPersonaDescription: false, matchCharacterDescription: false, matchCharacterPersonality: false, 
                    matchCharacterDepthPrompt: false, matchScenario: false, matchCreatorNotes: false, 
                    probability: 100, useProbability: true, depth: 4, outletName: "", group: "", 
                    groupOverride: false, groupWeight: 100, useGroupScoring: null, scanDepth: null, 
                    automationId: "", role: 0, sticky: 0, cooldown: 0, delay: 0, characterFilter: [], 
                    characterFilterExclude: false, triggers: [], caseSensitive: null, matchWholeWords: null 
                };
                currentEntryId.value = newId.toString();
            };

            // åˆ é™¤æ¡ç›®
            const deleteEntry = (id) => {
                if (confirm("ç¡®å®šè¦åˆ é™¤è¿™ä¸ªæ¡ç›®å—ï¼Ÿ")) {
                    delete worldInfoData.value[id];
                    currentEntryId.value = null;
                }
            };

            // é«˜çº§ç»‘å®šè®¡ç®—å±æ€§ï¼šå°† JSON ä¸­çš„æ•°ç»„è½¬åŒ–ä¸ºé€—å·åˆ†éš”çš„å­—ç¬¦ä¸²ï¼Œæ–¹ä¾¿å‰ç«¯ç¼–è¾‘
            const keysString = computed({
                get() {
                    const entry = worldInfoData.value[currentEntryId.value];
                    return entry && entry.key ? entry.key.join(', ') : '';
                },
                set(newValue) {
                    const entry = worldInfoData.value[currentEntryId.value];
                    if (entry) {
                        entry.key = newValue ? newValue.split(',').map(s => s.trim()).filter(Boolean) : [];
                    }
                }
            });

            // é«˜çº§ç»‘å®šè®¡ç®—å±æ€§ï¼šåè½¬ disable ä¸º enable
            const isEntryEnabled = computed({
                get() {
                    return !worldInfoData.value[currentEntryId.value]?.disable;
                },
                set(newValue) {
                    if (worldInfoData.value[currentEntryId.value]) {
                        worldInfoData.value[currentEntryId.value].disable = !newValue;
                    }
                }
            });

            return {
                worldInfoData, currentEntryId, searchQuery, fileName,
                filteredEntries, keysString, isEntryEnabled,
                importFile, exportFile, addEntry, deleteEntry, selectEntry
            };
        }
    }).mount('#app');
</script>

</body>
</html>
